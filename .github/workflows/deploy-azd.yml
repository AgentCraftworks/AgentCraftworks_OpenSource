name: Deploy with Azure Developer CLI

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to Azure with azd
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Azure Developer CLI
        run: |
          curl -fsSL https://aka.ms/install-azd.sh | bash
          echo "$HOME/.azd/bin" >> $GITHUB_PATH

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Initialize azd environment
        run: |
          azd env select ${{ secrets.AZURE_ENV_NAME }} || azd env new ${{ secrets.AZURE_ENV_NAME }} --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }} --location ${{ secrets.AZURE_LOCATION }}

      - name: Set GitHub App configuration
        run: |
          azd env set GH_APP_ID "${{ secrets.GH_APP_ID }}"
          azd env set GH_WEBHOOK_SECRET "${{ secrets.GH_WEBHOOK_SECRET }}"
          azd env set GH_APP_PRIVATE_KEY "${{ secrets.GH_APP_PRIVATE_KEY }}"
          azd env set POSTGRES_PASSWORD "${{ secrets.POSTGRES_PASSWORD }}"

      - name: Deploy to Azure
        run: azd up --no-prompt

      - name: Get deployment outputs
        id: outputs
        run: |
          echo "typescript-url=$(azd env get-value TYPESCRIPT_APP_URL)" >> $GITHUB_OUTPUT

      - name: Deployment summary
        run: |
          echo "## Deployment Complete! üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**TypeScript API:** ${{ steps.outputs.outputs.typescript-url }}" >> $GITHUB_STEP_SUMMARY

  smoke-tests:
    name: Run Smoke Tests
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install Azure Developer CLI
        run: |
          curl -fsSL https://aka.ms/install-azd.sh | bash
          echo "$HOME/.azd/bin" >> $GITHUB_PATH

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get deployment URLs
        id: urls
        run: |
          azd env select ${{ secrets.AZURE_ENV_NAME }} || azd env new ${{ secrets.AZURE_ENV_NAME }} --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }} --location ${{ secrets.AZURE_LOCATION }}
          echo "typescript-url=$(azd env get-value TYPESCRIPT_APP_URL)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript smoke tests
        env:
          BASE_URL: ${{ steps.urls.outputs.typescript-url }}
        run: npx -w typescript tsx smoke-test.ts

      - name: Notify on success
        if: success()
        run: echo "‚úÖ All smoke tests passed in production!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Smoke tests failed in production!"
          exit 1
