name: Deploy Infrastructure (azd)

# Infrastructure provisioning for new environments.
# Run manually to provision Azure resources via Azure Developer CLI.
# Uses OIDC federated credentials — no stored Azure secrets.

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - up (provision + deploy)
          - provision (infrastructure only)
          - deploy (app only)
          - down (destroy all resources)

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: "azd ${{ github.event.inputs.action }} → ${{ github.event.inputs.environment }}"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install azd
        uses: Azure/setup-azd@v2

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to azd (federated)
        run: |
          azd auth login \
            --client-id "${{ secrets.AZURE_CLIENT_ID }}" \
            --federated-credential-provider github \
            --tenant-id "${{ secrets.AZURE_TENANT_ID }}"

      - name: Select or create azd environment
        env:
          ENV_NAME: "agentcraftworks-${{ github.event.inputs.environment }}"
        run: |
          if ! azd env select "$ENV_NAME" 2>/dev/null; then
            echo "Creating new azd environment: $ENV_NAME"
            azd env new "$ENV_NAME" \
              --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
              --location "${{ secrets.AZURE_LOCATION }}"
          fi

          echo "Setting environment parameters..."
          azd env set AZURE_ENV_NAME "$ENV_NAME"
          azd env set AZURE_LOCATION "${{ secrets.AZURE_LOCATION }}"
          echo "Done configuring azd environment."

      - name: Configure environment secrets
        env:
          GH_APP_PRIVATE_KEY_VALUE: ${{ secrets.GH_APP_PRIVATE_KEY }}
          POSTGRES_PASSWORD_SECRET: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          azd env set ghAppId "${{ secrets.GH_APP_ID }}"
          azd env set ghWebhookSecret "${{ secrets.GH_WEBHOOK_SECRET }}"

          # Store PEM key as single line to avoid JSON parse errors in parameters.json substitution.
          # azd env set writes to .env; multiline values break JSON when ${ghAppPrivateKey} is resolved.
          SINGLE_LINE_KEY=$(printf '%s' "$GH_APP_PRIVATE_KEY_VALUE" | tr '\n' '|' | sed 's/|/\\n/g')
          azd env set ghAppPrivateKey "$SINGLE_LINE_KEY"

          # Prefer a stable password from POSTGRES_PASSWORD secret when provided.
          if [ -n "$POSTGRES_PASSWORD_SECRET" ]; then
            azd env set postgresPassword "$POSTGRES_PASSWORD_SECRET"
          else
            # If already set in azd env, keep existing value; otherwise generate once.
            if azd env get-values | grep -q '^postgresPassword='; then
              echo "::notice::postgresPassword already set in azd environment; leaving unchanged."
            else
              azd env set postgresPassword "$(openssl rand -base64 32)"
            fi
          fi

      - name: Run azd (provision + deploy)
        if: github.event.inputs.action == 'up (provision + deploy)'
        run: azd up --no-prompt

      - name: Run azd provision (infrastructure only)
        if: github.event.inputs.action == 'provision (infrastructure only)'
        run: azd provision --no-prompt

      - name: Run azd deploy (app only)
        if: github.event.inputs.action == 'deploy (app only)'
        run: azd deploy --no-prompt

      - name: Run azd down (destroy)
        if: github.event.inputs.action == 'down (destroy all resources)'
        run: azd down --force --purge --no-prompt

      - name: Output environment values
        if: github.event.inputs.action != 'down (destroy all resources)'
        run: azd env get-values | grep -E "URL|HOST|NAME" | sed 's/=.*/=<REDACTED>/'

  smoke-tests:
    name: Run Smoke Tests
    needs: deploy
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    if: "!contains(github.event.inputs.action, 'down')"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install azd
        uses: Azure/setup-azd@v2

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to azd (federated)
        run: |
          azd auth login \
            --client-id "${{ secrets.AZURE_CLIENT_ID }}" \
            --federated-credential-provider github \
            --tenant-id "${{ secrets.AZURE_TENANT_ID }}"

      - name: Get app URL
        id: env
        run: |
          ENV_NAME="agentcraftworks-${{ github.event.inputs.environment }}"
          azd env select "$ENV_NAME"
          APP_URL=$(azd env get-values | grep TYPESCRIPT_APP_URL | cut -d'=' -f2 | tr -d '"')
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Run smoke tests
        env:
          BASE_URL: ${{ steps.env.outputs.app_url }}
        run: npx -w typescript tsx smoke-test.ts
